# MyHomeManager 開発ログ

## プロジェクト情報
- **プロジェクト名**: MyHomeManager
- **バージョン**: 1.0.0
- **開始日**: 2025-11-23
- **最終更新**: 2025-11-28

---

## 開発履歴

### 2025-11-28

#### 詳細設計書のリバースエンジニアリング
**担当**: AI開発アシスタント  
**時刻**: 07:24 - 07:30

**作業内容**:
- 既存のMyHomeManagerプロジェクトの全ソースコードを分析
- 13ファイル（HTML×4、JavaScript×4、CSS×5）を詳細に調査
- 包括的な詳細設計書を作成（約500行のMarkdownドキュメント）

**成果物**:
- `doc/詳細設計書.md` - システム概要、アーキテクチャ設計、画面設計、データ設計、機能設計を網羅

**詳細**:
- システム構成図をMermaidで作成
- データモデル定義（TaskData, EntryData, EventData, SettingsObject）
- 全4画面の詳細設計を文書化
- セキュリティ対策（XSS対策）を記録
- 将来の拡張計画を明記

---

#### 出納帳ページの大幅改修
**担当**: AI開発アシスタント  
**時刻**: 07:33 - 07:44

##### フェーズ1: カラム構成の変更（07:33-07:35）

**要件**:
- 出納帳を「人からもらった/送った金額」を記録する形式に変更

**変更内容**:
1. **データ構造の変更**:
   ```javascript
   // 変更前
   { date, desc, amount, category }
   
   // 変更後
   { date, amount, person, type }
   ```

2. **カラム構成の変更**:
   - 変更前: 日付 | 説明 | カテゴリ | 金額 | 操作
   - 変更後: 日付 | 金額 | 誰に/誰から | 種別 | 操作

3. **金額表示の改善**:
   - もらった金額: **+¥5,000**（緑色、太字）
   - 送った金額: **-¥3,000**（赤色、太字）
   - 符号付きで視覚的に判別しやすく

**修正ファイル**:
- `html/cashbook.html` - フォームとテーブルヘッダーの修正
- `js/cashbook.js` - データ構造とレンダリングロジックの変更
- `css/cashbook.css` - `.positive`/`.negative`クラスの追加

**検証結果**: ✅ ブラウザテストで動作確認完了

---

##### フェーズ2: 冠婚葬祭費対応（07:40-07:44）

**要件**:
1. 合計金額を金額列に配置
2. 種別を冠婚葬祭費の選択肢に変更

**変更内容**:
1. **テーブルフッターの調整**:
   ```html
   <!-- 変更前 -->
   <td colspan="3">合計</td>
   <td id="total-amount">0</td>
   
   <!-- 変更後 -->
   <td>合計</td>
   <td id="total-amount">0</td>
   <td colspan="2"></td>
   ```

2. **種別の選択肢拡充**:
   - 変更前: もらった / 送った
   - 変更後: 
     - 香典（受取系）
     - お祝い（受取系）
     - お見舞い（受取系）
     - お年玉（受取系）
     - お礼（支払系）
     - お返し（支払系）
     - その他（支払系）

3. **自動判定ロジックの実装**:
   ```javascript
   const receiveTypes = ['香典', 'お祝い', 'お見舞い', 'お年玉'];
   const isReceive = receiveTypes.includes(e.type);
   const displayAmount = isReceive ? amount : -amount;
   ```

**修正ファイル**:
- `html/cashbook.html` - 選択肢の追加、テーブルフッターの調整
- `js/cashbook.js` - 受取/支払の自動判定ロジック追加

**検証結果**: ✅ ブラウザテストで動作確認完了
- 香典（¥10,000）→ **+¥10,000**（緑色）
- お礼（¥5,000）→ **-¥5,000**（赤色）
- 合計: ¥5,000（金額列に正しく表示）

---

### 2025-11-23（初回開発）

**作業内容**: プロジェクトの基盤構築
- ホーム画面（タスク管理）の実装
- 出納帳機能の実装
- カレンダー機能の実装
- 設定画面の実装
- サイドバーナビゲーションの実装
- Chart.jsによるデータ可視化の実装
- LocalStorageによるデータ永続化

---

## 技術スタック

### フロントエンド
- **HTML5**: セマンティックなマークアップ
- **CSS3**: カスタムスタイリング、レスポンシブデザイン
- **JavaScript (ES6+)**: Vanilla JavaScript、非フレームワーク

### データ管理
- **LocalStorage API**: ブラウザベースのデータ永続化
- **JSON**: データ形式

### 外部ライブラリ
- **Chart.js 4.4.0**: グラフ描画（月次収支推移、カテゴリ別内訳）

---

## データベーススキーマ（LocalStorage）

### cashbookEntries
```javascript
{
  date: "YYYY-MM-DD",     // 日付
  amount: number,          // 金額
  person: string,          // 相手の名前
  type: string            // 種別（香典、お祝い等）
}
```

### tasks
```javascript
{
  title: string,           // タスク名
  category: string         // カテゴリ
}
```

### calendarEvents
```javascript
{
  date: "YYYY-MM-DD",     // 日付
  title: string,           // イベント名
  time: "HH:MM"           // 時刻（オプション）
}
```

### appSettings
```javascript
{
  appName: string,         // アプリ名
  theme: string,           // テーマ
  enableNotifications: boolean,
  reminderEvents: boolean
}
```

---

## 機能一覧

### 実装済み機能
- ✅ タスク管理（追加、削除、一覧表示）
- ✅ 出納帳（冠婚葬祭費の記録、±表示、色分け）
- ✅ データエクスポート/インポート（JSON形式）
- ✅ 月次収支推移グラフ
- ✅ カテゴリ別内訳グラフ
- ✅ カレンダー表示（日/月表示）
- ✅ イベント管理（追加、削除、一覧）
- ✅ 設定画面（アプリ設定、データ削除）
- ✅ レスポンシブデザイン
- ✅ アクセシビリティ対応（ARIA属性）

### 準備中機能
- ⏳ ダークモード
- ⏳ 通知機能
- ⏳ イベントリマインダー

---

## セキュリティ対策

1. **XSS対策**:
   - `escapeHtml()`関数でユーザー入力をエスケープ
   - HTML特殊文字を安全な文字列に変換

2. **データバリデーション**:
   - HTML5の`required`属性で必須入力チェック
   - `type="number"`, `type="date"`, `type="time"`で型安全性を確保

---

## パフォーマンス最適化

1. **スクリプト遅延ロード**: 
   - 全JavaScriptファイルに`defer`属性を使用
   
2. **IIFE パターン**: 
   - グローバルスコープの汚染を防止
   
3. **条件付きライブラリロード**: 
   - Chart.jsは出納帳ページのみロード

---

## ブラウザ互換性

- ✅ Google Chrome（最新版）
- ✅ Mozilla Firefox（最新版）
- ✅ Microsoft Edge（最新版）
- ✅ Safari（最新版）

---

## 既知の問題

### 制限事項
1. **データ容量**: LocalStorageの制限（5-10MB）に依存
2. **同期**: 複数デバイス間でのデータ共有不可
3. **バックアップ**: 手動エクスポートのみ

### 改善予定
- [ ] 自動バックアップ機能
- [ ] PWA化（オフライン対応）
- [ ] 複数ユーザー対応
- [ ] CSVエクスポート対応

---

## テスト記録

### 2025-11-28 出納帳機能テスト

#### テストケース1: 基本機能
- ✅ エントリ追加（香典、お礼）
- ✅ 金額の符号表示（+/-）
- ✅ 色分け表示（緑/赤）
- ✅ 合計金額の計算
- ✅ エントリ削除

#### テストケース2: データ管理
- ✅ LocalStorageへの保存
- ✅ ページリロード後のデータ復元
- ✅ エクスポート機能（JSON）
- ✅ インポート機能（JSON）

#### テストケース3: グラフ表示
- ✅ 月次収支推移グラフの描画
- ✅ カテゴリ別内訳グラフの描画
- ✅ データ更新時のグラフ再描画

---

## ファイル構成

```
MyHomeManager/
├── doc/
│   ├── 詳細設計書.md         # システム全体の設計ドキュメント
│   └── 開発ログ.md           # このファイル
├── html/
│   ├── top.html              # ホーム画面
│   ├── cashbook.html         # 出納帳
│   ├── calendar.html         # カレンダー
│   └── settings.html         # 設定
├── css/
│   ├── top.css               # ホーム画面スタイル
│   ├── cashbook.css          # 出納帳スタイル
│   ├── calendar.css          # カレンダースタイル
│   ├── settings.css          # 設定スタイル
│   └── sidebar.css           # 共通サイドバー
└── js/
    ├── top.js                # タスク管理ロジック
    ├── cashbook.js           # 出納帳ロジック
    ├── calendar.js           # カレンダーロジック
    └── settings.js           # 設定ロジック
```

---

## 参考リンク

- [Chart.js ドキュメント](https://www.chartjs.org/)
- [MDN Web Docs - LocalStorage](https://developer.mozilla.org/ja/docs/Web/API/Window/localStorage)
- [MDN Web Docs - ARIA](https://developer.mozilla.org/ja/docs/Web/Accessibility/ARIA)

---

## 開発メモ

### コーディング規約
- **命名規則**: キャメルケース（JavaScript）、ケバブケース（CSS）
- **インデント**: スペース2個
- **コメント**: 日本語で記述
- **関数**: 単一責任の原則に従う

### デバッグTips
1. ブラウザの開発者ツールでLocalStorageを確認: `Application > Local Storage`
2. エラーログの確認: `Console`タブ
3. データのクリア: 設定画面から各種データを削除可能
4. **JSONデータの直接取得** (開発者向け):
   ```javascript
   // 出納帳データをJSON形式で取得
   console.log(localStorage.getItem('cashbookEntries'));
   
   // タスクデータを取得
   console.log(localStorage.getItem('tasks'));
   
   // カレンダーイベントを取得
   console.log(localStorage.getItem('calendarEvents'));
   
   // 全データを取得
   console.log({
     cashbook: JSON.parse(localStorage.getItem('cashbookEntries')),
     tasks: JSON.parse(localStorage.getItem('tasks')),
     events: JSON.parse(localStorage.getItem('calendarEvents')),
     settings: JSON.parse(localStorage.getItem('appSettings'))
   });
   
   // データを削除（注意！元に戻せません）
   localStorage.removeItem('cashbookEntries');  // 出納帳のみ削除
   localStorage.clear();  // 全データ削除
   ```

---

### 2025-11-30

#### 出納帳機能の改善（第1フェーズ）
**担当**: AI開発アシスタント  
**時刻**: 11:56 - 12:02

**要件**:
1. 出納帳で行を追加した後、項目を修正できるようにする
2. 「誰から/誰に」の項目を、既入力の中から選択と自由入力できる形にする
3. 追加後に、入力欄の日付が今日の日付となるようにする

**変更内容**:

##### 1. 編集機能の追加
- 各行に「編集」ボタンを追加
- 編集ボタンをクリックすると、上部のフォームにデータが入力される
- 送信ボタンが「追加」→「更新」に変わる
- Escキーで編集をキャンセル可能

**実装の詳細**:
```javascript
let editingIndex = null;  // 編集中のインデックスを管理

function startEdit(idx) {
  // フォームにデータを入力
  document.getElementById('entry-date').value = entries[idx].date;
  document.getElementById('entry-amount').value = entries[idx].amount;
  // ... (省略)
  editingIndex = idx;
  submitBtn.textContent = '更新';
}
```

##### 2. datalistによる入力候補の表示
- HTML5の`<datalist>`要素を使用
- 既存のエントリから「誰から/誰に」の候補を抽出
- 自由入力も可能（新しい名前も入力できる）

**実装の詳細**:
```html
<input type="text" id="entry-person" list="person-list" required />
<datalist id="person-list">
  <!-- JavaScriptで動的に候補を追加 -->
</datalist>
```

```javascript
function updatePersonList() {
  const uniquePersons = [...new Set(entries.map(e => e.person))];
  personList.innerHTML = '';
  uniquePersons.forEach(person => {
    const option = document.createElement('option');
    option.value = person;
    personList.appendChild(option);
  });
}
```

##### 3. 日付の自動設定
- ページ読み込み時に今日の日付を設定
- エントリ追加/更新後に日付フィールドをリセット
- `form.reset()`の後に日付を再設定

**実装の詳細**:
```javascript
function getTodayDateString() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function setTodayDate() {
  const dateInput = document.getElementById('entry-date');
  if (dateInput) {
    dateInput.value = getTodayDateString();
  }
}
```

**修正ファイル**:
- `html/cashbook.html` - datalist要素の追加、submitボタンにID追加
- `js/cashbook.js` - 編集機能、datalist更新、日付自動設定の実装

**検証結果**: ✅ ブラウザテストで動作確認完了

---

#### 出納帳機能の改善（第2フェーズ・インライン編集）
**担当**: AI開発アシスタント  
**時刻**: 12:03 - 12:08

**要件**:
- 編集ボタンを押したときに、上部のフォームではなく、テーブルの行内で直接編集する

**変更内容**:

##### インライン編集機能の実装
- 編集ボタンをクリックすると、その行のセルが入力フィールドに変わる
- 「更新」と「キャンセル」ボタンが行内に表示される
- 上部のフォームは新規追加専用として保持

**実装の詳細**:

1. **行の表示モード**:
   ```javascript
   function renderNormalRow(tr, e, idx) {
     // 通常表示: 日付、金額、相手、種別、編集/削除ボタン
   }
   
   function renderEditRow(tr, e, idx) {
     // 編集モード: 入力フィールド、更新/キャンセルボタン
   }
   ```

2. **編集モードの管理**:
   ```javascript
   function startInlineEdit(idx) {
     editingIndex = idx;
     render();  // 該当行を編集モードで再描画
   }
   
   function saveInlineEdit(idx) {
     const tr = tableBody.querySelector(`tr:nth-child(${idx + 1})`);
     const date = tr.querySelector('.edit-date').value;
     // データを更新してから通常表示に戻す
   }
   
   function cancelInlineEdit() {
     editingIndex = null;
     render();  // 通常表示に戻す
   }
   ```

3. **CSSスタイル**:
   - 編集ボタン: 青色（`#2196f3`）
   - 削除ボタン: 赤色（`#f44336`）
   - 更新ボタン: 緑色（`#4caf50`）
   - キャンセルボタン: グレー（`#757575`）
   - 各ボタンにホバー効果を追加
   - 入力フィールドは100%幅で統一

**修正ファイル**:
- `js/cashbook.js` - インライン編集機能の実装
- `css/cashbook.css` - インライン編集用のスタイル追加

**検証結果**: ✅ ブラウザテストで動作確認完了
- 編集ボタンクリック → 行が編集モードに切り替わる
- 値を変更して更新ボタン → 正しく保存される
- キャンセルボタン → 変更が破棄される
- 上部のフォームは編集に使用されない

**ユーザー体験の向上**:
- ✅ 編集が直感的（どの行を編集しているかが明確）
- ✅ スクロールが不要（上部フォームまで移動する必要がない）
- ✅ 新規追加との混同がない
- ✅ 視覚的フィードバックが明確

---

## テスト記録

### 2025-11-30 出納帳機能テスト

#### テストケース4: 編集機能（第1フェーズ）
- ✅ エントリ追加後の編集ボタン表示
- ✅ 編集ボタンクリック時のフォーム入力
- ✅ 送信ボタンのテキスト変更（「追加」→「更新」）
- ✅ 更新後のデータ反映
- ✅ Escキーでの編集キャンセル

#### テストケース5: datalist機能
- ✅ 入力候補の表示（既存の名前）
- ✅ 候補からの選択
- ✅ 新しい名前の自由入力
- ✅ 新規エントリ追加後の候補更新

#### テストケース6: 日付自動設定
- ✅ ページ読み込み時の日付設定
- ✅ エントリ追加後の日付リセット
- ✅ エントリ更新後の日付リセット

#### テストケース7: インライン編集機能（第2フェーズ）
- ✅ 編集ボタンクリック → 行が編集モードに変わる
- ✅ 入力フィールドとボタンの表示
- ✅ 値の変更と更新ボタンクリック → データ保存
- ✅ キャンセルボタンクリック → 変更破棄
- ✅ 上部フォームが編集に使用されない

---

---

#### 出納帳機能の改善（第3フェーズ・お祝いとお返しの紐付け）
**担当**: AI開発アシスタント  
**時刻**: 14:27 - 14:40

**要件**:
- お祝い/お見舞いとお返しを紐付けられるようにする
- お返し対象は同じ人のお祝い/お見舞いのみ表示
- 半返し金額を自動入力
- 既存データに対しても対応（マイグレーション）

**変更内容**:

##### 1. データ構造の拡張

既存のエントリデータに以下のフィールドを追加:

```javascript
{
  id: "entry_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9),
  date: "2025-11-30",
  amount: 10000,
  person: "山田太郎",
  type: "お祝い",
  relatedTo: null,      // お返しの場合、関連するお祝いのID
  hasReturn: false      // お祝い/お見舞いのお返し済みフラグ
}
```

**フィールドの役割**:
- `id`: エントリのユニークID（タイムスタンプ + ランダム文字列）
- `relatedTo`: お返しエントリが参照する元のお祝い/お見舞いのID
- `hasReturn`: お祝い/お見舞いが既にお返し済みかどうか

##### 2. データマイグレーション

ページ読み込み時に既存データを自動的に変換:

```javascript
function migrateData() {
  let needsMigration = false;
  
  entries = entries.map(entry => {
    if (!entry.id) {
      needsMigration = true;
      entry.id = generateId();
      entry.relatedTo = null;
      entry.hasReturn = false;
    }
    return entry;
  });
  
  if (needsMigration) {
    save();
    console.log('データマイグレーション完了');
  }
}
```

##### 3. お返し選択UI

種別で「お返し」を選択すると、以下のUIが表示:
- チェックボックス: 「これは『お祝い/お見舞い』へのお返しです」
- ドロップダウン: 関連するお祝い/お見舞いの選択

**候補の絞り込み**:
```javascript
function updateRelatedEntryOptions() {
  const person = document.getElementById('entry-person').value.trim();
  
  // 同じ人のお祝い/お見舞いで、まだお返ししていないもの
  const candidates = entries.filter(e => 
    e.person === person &&
    (e.type === 'お祝い' || e.type === 'お見舞い') &&
    !e.hasReturn
  );
  
  // ドロップダウンに追加
  candidates.forEach(e => {
    option.textContent = `${e.person}さん ¥${e.amount.toLocaleString()} (${e.date.substring(5)} ${e.type})`;
  });
}
```

##### 4. 半返し金額の自動設定

お祝い/お見舞いを選択すると、金額が自動的に50%で設定:

```javascript
relatedSelect.addEventListener('change', function() {
  const relatedEntry = entries.find(e => e.id === this.value);
  if (relatedEntry) {
    const halfAmount = Math.round(relatedEntry.amount / 2);
    document.getElementById('entry-amount').value = halfAmount;
  }
});
```

##### 5. テーブル表示の関連情報

「関連」列を追加し、お返し状況を表示:

```javascript
let relationInfo = '';
if (e.type === 'お祝い' || e.type === 'お見舞い') {
  relationInfo = e.hasReturn ? '✓お返し済' : '未お返し';
} else if (e.type === 'お返し' && e.relatedTo) {
  const relatedEntry = entries.find(entry => entry.id === e.relatedTo);
  if (relatedEntry) {
    relationInfo = `←${relatedEntry.date.substring(5)}の${relatedEntry.type}`;
  }
}
```

**表示例**:
```
日付       | 金額      | 誰に/誰から | 種別      | 関連           | 操作
-----------+-----------+-------------+-----------+----------------+--------------
2025-12-01 | +¥10,000  | 田中太郎    | お祝い    | ✓お返し済     | 編集 削除
2025-12-01 | -¥5,000   | 田中太郎    | お返し    | ←12-01のお祝い| 編集 削除
```

##### 6. 削除時の関連処理

**お返しを削除した場合**:
```javascript
if (deletedEntry.type === 'お返し' && deletedEntry.relatedTo) {
  const relatedEntry = entries.find(e => e.id === deletedEntry.relatedTo);
  if (relatedEntry) {
    relatedEntry.hasReturn = false;  // フラグをリセット
  }
}
```

**お祝い/お見舞いを削除した場合**:
- 関連するお返しがある場合、確認メッセージを表示
- ユーザーの選択に応じて処理:
  - 両方削除 or お祝いのみ削除（お返しの関連を解除）

**修正ファイル**:
- `html/cashbook.html` - お返し関連UI、テーブルヘッダーに「関連」列追加
- `js/cashbook.js` - データマイグレーション、関連選択、半返し計算、削除処理
- `css/cashbook.css` - お返しセクション、関連情報のスタイル

**検証結果**: ✅ ブラウザテストで動作確認完了
- データマイグレーション正常動作
- 同じ人の候補のみ表示
- 半返し金額の自動入力（¥10,000 → ¥5,000）
- テーブルの関連情報表示
- お返し削除時のフラグリセット
- お祝い削除時の確認メッセージ

**対象種別**:
- ✅ お祝い → お返し
- ✅ お見舞い → お返し
- ❌ 香典（将来対応予定）

**制約事項**:
- 1つのお祝い/お見舞いに対して1つのお返しのみ
- お返し対象は同じ人のお祝い/お見舞いのみ

---

## テスト記録

### 2025-11-30 お祝いとお返しの紐付け機能テスト

#### テストケース8: データマイグレーション
- ✅ 既存データにIDが付与される
- ✅ `relatedTo`と`hasReturn`フィールドが追加される
- ✅ データの整合性が保たれる

#### テストケース9: お返し選択UI
- ✅ 種別で「お返し」選択時にチェックボックス表示
- ✅ チェックONで関連選択ドロップダウン表示
- ✅ 相手の名前入力で候補が更新される

#### テストケース10: 関連候補の絞り込み
- ✅ 同じ人のお祝い/お見舞いのみ表示
- ✅ 他の人のエントリは表示されない
- ✅ お返し済みのエントリは除外される
- ✅ 香典は候補に含まれない（仕様通り）

#### テストケース11: 半返し金額
- ✅ お祝い選択時に金額が50%で自動入力
- ✅ 四捨五入の計算が正しい（¥10,000 → ¥5,000）
- ✅ 手動で金額変更が可能

#### テストケース12: 関連情報の表示
- ✅ お祝い/お見舞いに「✓お返し済」または「未お返し」表示
- ✅ お返しに「←{日付}の{種別}」表示
- ✅ 関連エントリが削除された場合の表示

#### テストケース13: 削除処理
- ✅ お返し削除時に元のお祝いの`hasReturn`がfalseに戻る
- ✅ お祝い削除時に確認メッセージが表示される
- ✅ 関連するお返しの処理が正しく行われる

---

**最終更新日時**: 2025-11-30 14:40  
**記録者**: AI開発アシスタント

